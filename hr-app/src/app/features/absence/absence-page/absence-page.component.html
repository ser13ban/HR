<div class="absence-container">
  <!-- Header -->
  <div class="absence-header">
    <button class="back-button" (click)="router.navigate(['/home'])" aria-label="Go back to home">
      <span class="back-icon">‚Üê</span>
      Back to Home
    </button>
    <h1 class="page-title">Absence Management</h1>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading absence data...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error() && !loading()" class="error-container">
    <div class="error-icon">‚ö†Ô∏è</div>
    <p class="error-message">{{ error() }}</p>
    <button class="retry-button" (click)="loadData()">Try Again</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading() && !error()" class="absence-content">
    
    <!-- Request Form Section -->
    <div class="section request-form-section">
      <div class="section-header">
        <h2>New Absence Request</h2>
        <button 
          class="toggle-form-button"
          (click)="onToggleRequestForm()"
          [class.active]="showRequestForm()"
        >
          <span class="toggle-icon">{{ showRequestForm() ? '‚àí' : '+' }}</span>
          {{ showRequestForm() ? 'Hide Form' : 'Request Absence' }}
        </button>
      </div>

      <div *ngIf="showRequestForm()" class="request-form-container">
        <form [formGroup]="requestForm" (ngSubmit)="onSubmitRequest()" class="request-form">
          
          <!-- Absence Type -->
          <div class="form-group">
            <label for="type">Absence Type *</label>
            <select id="type" formControlName="type" class="form-control">
              <option *ngFor="let option of getAbsenceTypeOptions()" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
            <div *ngIf="requestForm.get('type')?.invalid && requestForm.get('type')?.touched" class="field-error">
              Absence type is required
            </div>
          </div>

          <!-- Start Date -->
          <div class="form-group">
            <label for="startDate">Start Date *</label>
            <input 
              id="startDate" 
              type="date" 
              formControlName="startDate" 
              class="form-control"
              [min]="getTodayDateString()"
            />
            <div *ngIf="requestForm.get('startDate')?.invalid && requestForm.get('startDate')?.touched" class="field-error">
              Start date is required
            </div>
          </div>

          <!-- End Date -->
          <div class="form-group">
            <label for="endDate">End Date *</label>
            <input 
              id="endDate" 
              type="date" 
              formControlName="endDate" 
              class="form-control"
              [min]="requestForm.get('startDate')?.value || getTodayDateString()"
            />
            <div *ngIf="requestForm.get('endDate')?.invalid && requestForm.get('endDate')?.touched" class="field-error">
              End date is required
            </div>
          </div>

          <!-- Reason -->
          <div class="form-group">
            <label for="reason">Reason *</label>
            <textarea 
              id="reason" 
              formControlName="reason" 
              class="form-control" 
              rows="4" 
              placeholder="Please provide a reason for your absence request..."
              maxlength="500"
            ></textarea>
            <div class="character-count">
              {{ requestForm.get('reason')?.value?.length || 0 }}/500
            </div>
            <div *ngIf="requestForm.get('reason')?.invalid && requestForm.get('reason')?.touched" class="field-error">
              <span *ngIf="requestForm.get('reason')?.errors?.['required']">Reason is required</span>
              <span *ngIf="requestForm.get('reason')?.errors?.['minlength']">Reason must be at least 10 characters</span>
              <span *ngIf="requestForm.get('reason')?.errors?.['maxlength']">Reason cannot exceed 500 characters</span>
            </div>
          </div>

          <!-- Submit Error -->
          <div *ngIf="submitError()" class="form-error">
            {{ submitError() }}
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button 
              type="submit" 
              class="submit-button"
              [disabled]="requestForm.invalid || submitting()"
            >
              <span *ngIf="submitting()" class="loading-icon">‚è≥</span>
              <span *ngIf="!submitting()">üì§</span>
              {{ submitting() ? 'Submitting...' : 'Submit Request' }}
            </button>
            <button 
              type="button" 
              class="cancel-button"
              (click)="onToggleRequestForm()"
              [disabled]="submitting()"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- My Requests Section -->
    <div class="section my-requests-section">
      <h2 class="section-title">My Absence Requests</h2>
      
      <div *ngIf="myRequests().length === 0" class="empty-state">
        <div class="empty-icon">üìÖ</div>
        <p>You haven't submitted any absence requests yet.</p>
      </div>

      <div *ngIf="myRequests().length > 0" class="requests-table-container">
        <table class="requests-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Dates</th>
              <th>Duration</th>
              <th>Status</th>
              <th>Submitted</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let request of myRequests()">
              <td>
                <span class="absence-type">{{ AbsenceTypeLabels[request.type] }}</span>
              </td>
              <td>
                <div class="date-range">
                  <span>{{ formatDate(request.startDate) }}</span>
                  <span class="date-separator">to</span>
                  <span>{{ formatDate(request.endDate) }}</span>
                </div>
              </td>
              <td>
                <span class="duration">{{ request.durationInDays }} day{{ request.durationInDays !== 1 ? 's' : '' }}</span>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusBadgeClass(request.status)">
                  {{ AbsenceStatusLabels[request.status] }}
                </span>
              </td>
              <td>
                <span class="submit-date">{{ formatDate(request.createdAt) }}</span>
              </td>
              <td>
                <div class="action-buttons">
                  <button 
                    *ngIf="canCancelRequest(request)"
                    class="cancel-request-button"
                    (click)="onCancelRequest(request)"
                    title="Cancel Request"
                  >
                    ‚ùå
                  </button>
                  <span *ngIf="!canCancelRequest(request)" class="no-actions">
                    ‚Äî
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Manager Section -->
    <div *ngIf="isManager()" class="section manager-section">
      <h2 class="section-title">Pending Approvals</h2>
      
      <div *ngIf="managerRequests().length === 0" class="empty-state">
        <div class="empty-icon">‚úÖ</div>
        <p>No pending requests to review.</p>
      </div>

      <div *ngIf="managerRequests().length > 0" class="requests-table-container">
        <table class="requests-table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Type</th>
              <th>Dates</th>
              <th>Duration</th>
              <th>Reason</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let request of managerRequests()">
              <td>
                <button class="employee-link" (click)="onViewProfile(request.employeeId)">
                  {{ request.employeeName }}
                </button>
              </td>
              <td>
                <span class="absence-type">{{ AbsenceTypeLabels[request.type] }}</span>
              </td>
              <td>
                <div class="date-range">
                  <span>{{ formatDate(request.startDate) }}</span>
                  <span class="date-separator">to</span>
                  <span>{{ formatDate(request.endDate) }}</span>
                </div>
              </td>
              <td>
                <span class="duration">{{ request.durationInDays }} day{{ request.durationInDays !== 1 ? 's' : '' }}</span>
              </td>
              <td>
                <div class="reason-cell" [title]="request.reason">
                  {{ request.reason }}
                </div>
              </td>
              <td>
                <div class="action-buttons">
                  <button 
                    class="approve-button"
                    (click)="onShowApprovalModal(request, 'approve')"
                    [disabled]="processingRequest() === request.id"
                    title="Approve Request"
                  >
                    ‚úÖ
                  </button>
                  <button 
                    class="decline-button"
                    (click)="onShowApprovalModal(request, 'decline')"
                    [disabled]="processingRequest() === request.id"
                    title="Decline Request"
                  >
                    ‚ùå
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Team Approved Absences -->
    <div class="section approved-section">
      <h2 class="section-title">Team Calendar - Approved Absences</h2>
      
      <div *ngIf="teamApprovedRequests().length === 0" class="empty-state">
        <div class="empty-icon">üìÖ</div>
        <p>No approved team absences to display.</p>
      </div>

      <div *ngIf="teamApprovedRequests().length > 0" class="requests-table-container">
        <table class="requests-table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Type</th>
              <th>Dates</th>
              <th>Duration</th>
              <th>Approved By</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let request of teamApprovedRequests()">
              <td>
                <button class="employee-link" (click)="onViewProfile(request.employeeId)">
                  {{ request.employeeName }}
                </button>
              </td>
              <td>
                <span class="absence-type">{{ AbsenceTypeLabels[request.type] }}</span>
              </td>
              <td>
                <div class="date-range">
                  <span>{{ formatDate(request.startDate) }}</span>
                  <span class="date-separator">to</span>
                  <span>{{ formatDate(request.endDate) }}</span>
                </div>
              </td>
              <td>
                <span class="duration">{{ request.durationInDays }} day{{ request.durationInDays !== 1 ? 's' : '' }}</span>
              </td>
              <td>
                <span class="approver">{{ request.approvedByName || 'System' }}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Approval Modal -->
  <div *ngIf="showApprovalModal()" class="modal-overlay" (click)="onCloseApprovalModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ approvalAction() === 'approve' ? 'Approve' : 'Decline' }} Absence Request</h3>
        <button class="modal-close" (click)="onCloseApprovalModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <div *ngIf="currentRequestForApproval()" class="request-details">
          <p><strong>Employee:</strong> {{ currentRequestForApproval()!.employeeName }}</p>
          <p><strong>Type:</strong> {{ AbsenceTypeLabels[currentRequestForApproval()!.type] }}</p>
          <p><strong>Dates:</strong> {{ formatDate(currentRequestForApproval()!.startDate) }} to {{ formatDate(currentRequestForApproval()!.endDate) }}</p>
          <p><strong>Duration:</strong> {{ currentRequestForApproval()!.durationInDays }} day{{ currentRequestForApproval()!.durationInDays !== 1 ? 's' : '' }}</p>
          <p><strong>Reason:</strong> {{ currentRequestForApproval()!.reason }}</p>
        </div>

        <form [formGroup]="approvalForm" (ngSubmit)="onSubmitApproval()">
          <div class="form-group">
            <label for="approverNotes">Notes (Optional)</label>
            <textarea 
              id="approverNotes" 
              formControlName="approverNotes" 
              class="form-control" 
              rows="3" 
              placeholder="Add any notes about this decision..."
              maxlength="500"
            ></textarea>
            <div class="character-count">
              {{ approvalForm.get('approverNotes')?.value?.length || 0 }}/500
            </div>
          </div>

          <div *ngIf="processingError()" class="form-error">
            {{ processingError() }}
          </div>

          <div class="modal-actions">
            <button 
              type="submit" 
              class="confirm-button"
              [class.approve]="approvalAction() === 'approve'"
              [class.decline]="approvalAction() === 'decline'"
              [disabled]="processingRequest() !== null"
            >
              <span *ngIf="processingRequest() !== null" class="loading-icon">‚è≥</span>
              <span *ngIf="processingRequest() === null">
                {{ approvalAction() === 'approve' ? '‚úÖ' : '‚ùå' }}
              </span>
              {{ approvalAction() === 'approve' ? 'Approve' : 'Decline' }}
            </button>
            <button 
              type="button" 
              class="cancel-button"
              (click)="onCloseApprovalModal()"
              [disabled]="processingRequest() !== null"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
