# Feature Plan: Login and Register Functionality

## Description
Implement user authentication system with registration and login functionality using .NET Identity, JWT tokens, and role-based access control (RBAC). The registration form will collect required fields (Name, Surname, Email, Password, Role) and optional fields (Description, Department, Team), then redirect to login page. The login will authenticate users with username/password and handle errors appropriately.

## Backend Changes (.NET API)

### Package Dependencies
- **File**: `HrAPI/HrAPI/HrAPI.csproj`
  - Add `Microsoft.AspNetCore.Identity.EntityFrameworkCore` package
  - Add `Microsoft.AspNetCore.Authentication.JwtBearer` package
  - Add `System.IdentityModel.Tokens.Jwt` package

### Data Models
- **File**: `HrAPI/HrAPI/Models/Employee.cs`
  - Add `PasswordHash` property (string, required)
  - Add `Team` property (string?, optional, MaxLength 100)
  - Add `Description` property (string?, optional, MaxLength 1000) 
  - Modify existing `Department` property to be optional for registration

### Database Context
- **File**: `HrAPI/HrAPI/Data/HrDbContext.cs`
  - Inherit from `IdentityDbContext<Employee, IdentityRole<int>, int>` instead of `DbContext`
  - Configure Identity tables with Employee as user entity
  - Update Employee entity configuration to include new password and optional fields
  - Add unique index constraint on Email if not already present

### DTOs (Data Transfer Objects)
- **New File**: `HrAPI/HrAPI/DTOs/RegisterRequestDto.cs`
  - Properties: FirstName, LastName, Email, Password, Role, Department?, Team?, Description?
  - Data annotations for validation

- **New File**: `HrAPI/HrAPI/DTOs/LoginRequestDto.cs`
  - Properties: Email (as username), Password
  - Data annotations for validation

- **New File**: `HrAPI/HrAPI/DTOs/AuthResponseDto.cs`
  - Properties: Token, RefreshToken?, User (Employee data without sensitive info), Expires

### Services
- **New File**: `HrAPI/HrAPI/Services/IAuthService.cs`
  - Interface defining: RegisterAsync, LoginAsync, GenerateJwtToken, ValidateToken methods

- **New File**: `HrAPI/HrAPI/Services/AuthService.cs`
  - Implement IAuthService interface
  - RegisterAsync: Create user with Identity, hash password, assign role
  - LoginAsync: Validate credentials, generate JWT token
  - GenerateJwtToken: Create JWT with user claims and role information
  - Error handling for duplicate emails, invalid credentials

### JWT Configuration
- **File**: `HrAPI/HrAPI/appsettings.json` and `HrAPI/HrAPI/appsettings.Development.json`
  - Add JWT configuration section: Key, Issuer, Audience, ExpireMinutes

### Controllers
- **New File**: `HrAPI/HrAPI/Controllers/AuthController.cs`
  - POST `/api/auth/register` endpoint accepting RegisterRequestDto
  - POST `/api/auth/login` endpoint accepting LoginRequestDto  
  - Return appropriate HTTP status codes (201 for register success, 200 for login success, 400 for validation errors, 401 for unauthorized)
  - Comprehensive error handling and user-friendly error messages

### Program.cs Configuration
- **File**: `HrAPI/HrAPI/Program.cs`
  - Configure Identity services with Employee as user entity
  - Configure JWT authentication middleware
  - Add Authorization middleware
  - Register IAuthService and AuthService in DI container
  - Configure password requirements and user validation rules

### Database Migration
- **New Migration**: Add Identity tables and update Employee table
  - Add ASP.NET Identity tables (AspNetUsers, AspNetRoles, etc.)
  - Add PasswordHash, Team, Description columns to Employee table
  - Seed default roles (Employee, Manager, Admin)

## Frontend Changes (Angular)

### Authentication Services
- **New File**: `hr-app/src/app/core/services/auth.service.ts`
  - Methods: register(), login(), logout(), getCurrentUser(), isAuthenticated()
  - HTTP client calls to backend auth endpoints
  - JWT token storage in localStorage/sessionStorage
  - Error handling and user-friendly error messages

### Guards
- **New File**: `hr-app/src/app/core/guards/auth.guard.ts`
  - Route guard to protect authenticated routes
  - Redirect to login if not authenticated

### Models/Interfaces  
- **New File**: `hr-app/src/app/core/models/auth.models.ts`
  - RegisterRequest, LoginRequest, AuthResponse, User interfaces
  - EmployeeRole enum matching backend

### Components
- **New File**: `hr-app/src/app/features/auth/register/register.component.ts`
  - Reactive form with required fields: firstName, lastName, email, password, role
  - Optional fields: department, team, description
  - Form validation with Angular validators
  - Submit handler calling AuthService.register()
  - Error display for validation and server errors
  - Success redirect to login page

- **New File**: `hr-app/src/app/features/auth/register/register.component.html`
  - Form template with proper form controls
  - Error message display
  - Loading states during submission

- **New File**: `hr-app/src/app/features/auth/register/register.component.sass`
  - Styling for registration form

- **New File**: `hr-app/src/app/features/auth/login/login.component.ts`
  - Reactive form with email and password fields
  - Form validation
  - Submit handler calling AuthService.login()
  - Error handling and display
  - Success redirect to main application

- **New File**: `hr-app/src/app/features/auth/login/login.component.html`
  - Login form template
  - Error message display
  - Loading states

- **New File**: `hr-app/src/app/features/auth/login/login.component.sass`
  - Styling for login form

### Routing
- **File**: `hr-app/src/app/app.routes.ts`
  - Add routes for `/login` and `/register`
  - Add default redirect to login for unauthenticated users
  - Protected routes using AuthGuard

### HTTP Interceptor
- **New File**: `hr-app/src/app/core/interceptors/auth.interceptor.ts`
  - Add JWT token to all HTTP requests
  - Handle 401 responses by redirecting to login

### App Configuration
- **File**: `hr-app/src/app/app.config.ts`
  - Configure HTTP client
  - Register auth interceptor
  - Configure routing

## Implementation Algorithm

### Registration Flow
1. User fills registration form with required fields (Name, Surname, Email, Password, Role) and optional fields (Description, Department, Team)
2. Frontend validates form data and sends POST to `/api/auth/register`
3. Backend validates request, checks for existing email
4. If valid, create Employee entity with hashed password using Identity
5. Assign specified role to user
6. Return success response
7. Frontend redirects user to login page

### Login Flow  
1. User enters email and password in login form
2. Frontend validates form and sends POST to `/api/auth/login`
3. Backend validates credentials using Identity
4. If valid, generate JWT token with user claims and role information
5. Return token and user data (without sensitive information)
6. Frontend stores token and redirects to main application
7. All subsequent API calls include JWT token in Authorization header
8. The user is redirected to dummy homepage 

### Error Handling
- Frontend displays validation errors inline with form fields
- Server errors displayed as user-friendly messages
- 401/403 responses trigger redirect to login
- Network errors handled gracefully with retry options

### Security Considerations
- Passwords hashed using Identity's default hashing (PBKDF2)
- JWT tokens include expiration time
- Role-based authorization on API endpoints
- Input validation on both frontend and backend
- HTTPS enforcement in production
