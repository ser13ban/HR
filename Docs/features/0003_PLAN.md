# Feature Plan: Profile Editing with Manager Permissions

## Description
Add profile editing functionality to the existing profile page where users can edit their own personal data, and managers can modify personal data for all co-workers in addition to their own. The feature will include form validation, role-based editing permissions, and proper error handling while maintaining the existing view-only functionality for co-workers.

## Backend Changes (.NET API)

### Data Models
- **File**: `HrAPI/HrAPI/Models/Employee.cs`
  - Add missing personal data fields:
    - `DateOfBirth` (DateTime?, nullable)
    - `Address` (string?, MaxLength 500)
    - `EmergencyContact` (string?, MaxLength 100)
    - `EmergencyPhone` (string?, MaxLength 20)
  - Update existing fields to ensure proper validation attributes

### Database Migration
- **New Migration**: Add personal data fields to Employee table
  - Add `DateOfBirth`, `Address`, `EmergencyContact`, `EmergencyPhone` columns
  - Update existing field constraints if needed
  - Ensure `UpdatedAt` field is properly configured for automatic updates

### DTOs
- **New File**: `HrAPI/HrAPI/DTOs/UpdateEmployeeDto.cs`
  - Properties: FirstName, LastName, Email, PhoneNumber, Department, Team, Position, Bio, ProfilePictureUrl, DateOfBirth, Address, EmergencyContact, EmergencyPhone
  - Data annotations for validation matching Employee model constraints
  - Exclude sensitive fields like Role, CreatedAt, UpdatedAt

### Controllers
- **File**: `HrAPI/HrAPI/Controllers/EmployeeController.cs`
  - Add `PUT /api/employees/{id}` endpoint for updating employee profiles
  - Implement permission checking logic:
    - Users can edit their own profile
    - Managers can edit any profile
    - Regular employees cannot edit other profiles
  - Validate incoming data using model validation
  - Update `UpdatedAt` timestamp automatically
  - Return updated employee profile using existing EmployeeProfileDto
  - Proper error handling for unauthorized access, validation errors, and not found scenarios

### Authorization Logic
- **File**: `HrAPI/HrAPI/Controllers/EmployeeController.cs` (UpdateEmployee method)
  - Check if current user ID matches target employee ID (own profile)
  - Check if current user has Manager or Admin role for editing others
  - Return 403 Forbidden for unauthorized edit attempts
  - Maintain existing role-based view permissions in GET endpoints

## Frontend Changes (Angular)

### Services
- **File**: `hr-app/src/app/core/services/employee.service.ts`
  - Add `updateEmployee(id: string, employeeData: UpdateEmployeeRequest): Observable<EmployeeProfile>` method
  - HTTP PUT call to `/api/employees/{id}` endpoint
  - Proper error handling and type safety

### Models
- **File**: `hr-app/src/app/core/models/employee.models.ts`
  - Add `UpdateEmployeeRequest` interface matching UpdateEmployeeDto
  - Update existing `EmployeeProfile` interface to include new personal data fields

### Profile Component Updates
- **File**: `hr-app/src/app/features/profile/profile.component.ts`
  - Add editing state management using signals:
    - `isEditing = signal<boolean>(false)`
    - `isManager = signal<boolean>(false)`
    - `canEdit = signal<boolean>(false)`
  - Add form-related imports: `FormBuilder`, `FormGroup`, `Validators`
  - Create reactive form with all editable fields
  - Add methods:
    - `toggleEditMode()`: Switch between view and edit modes
    - `saveProfile()`: Submit form data to API
    - `cancelEdit()`: Discard changes and exit edit mode
    - `canEditProfile()`: Check if current user can edit this profile
  - Form validation with proper error handling
  - Update loading and error states for save operations

- **File**: `hr-app/src/app/features/profile/profile.component.html`
  - Add edit mode toggle functionality with conditional rendering
  - Replace static text with form inputs when in edit mode
  - Add "Edit Profile" button (visible when user can edit)
  - Add "Save" and "Cancel" buttons in edit mode
  - Form validation error display
  - Loading states during save operations
  - Maintain existing role-based field visibility logic

- **File**: `hr-app/src/app/features/profile/profile.component.sass`
  - Add styles for form inputs and buttons
  - Edit mode specific styling
  - Form validation error styling
  - Responsive design for form layout
  - Maintain consistency with existing profile styling

### Form Imports
- **File**: `hr-app/src/app/features/profile/profile.component.ts`
  - Import `ReactiveFormsModule` for reactive forms
  - Import `CommonModule` for common Angular directives (already present)

## Implementation Algorithm

### Edit Permission Check Flow
1. When profile component loads, determine current user's relationship to profile:
   - Get current user ID and role from AuthService
   - Compare with profile owner ID
   - Set `canEdit` signal based on:
     - Own profile: true
     - Manager/Admin viewing any profile: true  
     - Regular employee viewing others: false

### Profile Editing Flow
1. User clicks "Edit Profile" button (only visible if `canEdit()` is true)
2. Component switches to edit mode (`isEditing.set(true)`)
3. Form is populated with current profile data
4. User modifies form fields with validation feedback
5. User clicks "Save":
   - Validate form data
   - Call `employeeService.updateEmployee()` with form data
   - Handle success: update profile display, exit edit mode, show success message
   - Handle errors: display validation errors or server errors
6. User clicks "Cancel": discard changes and exit edit mode

### Form Validation Rules
- **FirstName/LastName**: Required, max 100 characters
- **Email**: Required, valid email format, max 256 characters
- **PhoneNumber**: Optional, max 20 characters, phone format validation
- **Department/Team/Position**: Optional, max 100 characters
- **Bio**: Optional, max 500 characters
- **DateOfBirth**: Optional, valid date, not in future
- **Address**: Optional, max 500 characters
- **EmergencyContact**: Optional, max 100 characters
- **EmergencyPhone**: Optional, max 20 characters, phone format validation

### Backend Update Process
1. Receive PUT request with employee ID and update data
2. Authenticate user and extract current user ID and role
3. Validate permissions (own profile or manager role)
4. Validate incoming data using model validation
5. Retrieve existing employee record
6. Update allowed fields (preserve Role, CreatedAt, etc.)
7. Set UpdatedAt to current timestamp
8. Save changes to database
9. Return updated employee profile with appropriate role-based filtering

### Error Handling
- **Frontend**: Display validation errors inline with form fields
- **Frontend**: Show server errors as user-friendly messages
- **Backend**: Return appropriate HTTP status codes:
  - 200 OK for successful updates
  - 400 Bad Request for validation errors
  - 401 Unauthorized for invalid tokens
  - 403 Forbidden for insufficient permissions
  - 404 Not Found for non-existent employees
  - 500 Internal Server Error for server issues

### Security Considerations
- Server-side permission validation for all update requests
- Input validation and sanitization on both frontend and backend
- Prevent role escalation by excluding Role field from updates
- Audit trail through UpdatedAt timestamp
- Maintain existing role-based view permissions
- HTTPS enforcement for sensitive personal data transmission

### User Experience Enhancements
- Auto-save draft functionality (future enhancement)
- Confirmation dialog for unsaved changes when navigating away
- Success/error toast notifications
- Loading spinners during save operations
- Form field focus management for better accessibility
- Responsive design for mobile editing experience
