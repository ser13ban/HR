# Feature Plan 0008: RBAC Refactor - Centralized Authorization in Services

## Brief Description

Refactor the current scattered Role-Based Access Control (RBAC) implementation to follow .NET best practices by centralizing authorization logic using ASP.NET Core's built-in authorization framework. The current implementation has authorization checks scattered across services with manual role checking, making it difficult to maintain and test. This refactor will create a centralized, reusable, and easily testable authorization system while keeping modifications limited to services only.

## Current State Analysis

The current RBAC implementation is scattered across three main service files:

1. **AbsenceService.cs**: Contains manual `IsEmployeeManagerAsync()` checks and hardcoded `UnauthorizedAccessException` throws in methods like `GetEmployeeAbsenceRequestsAsync`, `GetPendingApprovalsForManagerAsync`, `ApproveAbsenceRequestAsync`, and `DeclineAbsenceRequestAsync`.

2. **EmployeeService.cs**: Contains inline authorization logic in `GetEmployeeByIdAsync` and `UpdateEmployeeAsync` with `DetermineIfLimitedView()` helper method and manual role comparisons.

3. **FeedbackService.cs**: Contains authorization methods `CanUserViewFeedbackAsync` and `CanUserGiveFeedbackAsync` with manual role checking and permission validation.

## Technical Implementation Plan

### Phase 1: Create Centralized Authorization Service

**Files to Create:**
- `HrAPI/Services/IAuthorizationService.cs` - Interface defining authorization methods
- `HrAPI/Services/AuthorizationService.cs` - Centralized authorization logic implementation

**Authorization Service Methods:**
```csharp
// Manager-specific permissions
Task<bool> IsManagerAsync(int userId);
Task<void> RequireManagerAsync(int userId);

// Employee profile access permissions  
Task<bool> CanViewEmployeeProfileAsync(int requestingUserId, int targetEmployeeId);
Task<bool> CanEditEmployeeProfileAsync(int requestingUserId, int targetEmployeeId);
Task<void> RequireEditEmployeeProfileAsync(int requestingUserId, int targetEmployeeId);

// Absence request permissions
Task<bool> CanViewAbsenceRequestsAsync(int requestingUserId, int targetEmployeeId);
Task<bool> CanApproveAbsenceRequestsAsync(int userId);
Task<void> RequireAbsenceApprovalPermissionAsync(int userId);

// Feedback permissions
Task<bool> CanViewFeedbackAsync(int requestingUserId, int targetEmployeeId);
Task<bool> CanGiveFeedbackAsync(int fromUserId, int toUserId);
Task<void> RequireFeedbackViewPermissionAsync(int requestingUserId, int targetEmployeeId);
```

### Phase 2: Refactor Service Dependencies

**Files to Modify:**
- `HrAPI/Services/AbsenceService.cs`
- `HrAPI/Services/EmployeeService.cs` 
- `HrAPI/Services/FeedbackService.cs`
- `HrAPI/Services/IAbsenceService.cs`
- `HrAPI/Services/IEmployeeService.cs`
- `HrAPI/Services/IFeedbackService.cs`

**AbsenceService.cs Changes:**
- Inject `IAuthorizationService` in constructor
- Replace `IsEmployeeManagerAsync()` calls with `_authorizationService.RequireManagerAsync()`
- Replace manual authorization checks in:
  - `GetEmployeeAbsenceRequestsAsync()` 
  - `GetPendingApprovalsForManagerAsync()`
  - `ApproveAbsenceRequestAsync()`
  - `DeclineAbsenceRequestAsync()`
- Remove `IsEmployeeManagerAsync()` method (moved to AuthorizationService)

**EmployeeService.cs Changes:**
- Inject `IAuthorizationService` in constructor
- Replace inline authorization logic in `GetEmployeeByIdAsync()` with `_authorizationService.CanViewEmployeeProfileAsync()`
- Replace inline authorization logic in `UpdateEmployeeAsync()` with `_authorizationService.RequireEditEmployeeProfileAsync()`
- Remove `DetermineIfLimitedView()` method logic (moved to AuthorizationService)

**FeedbackService.cs Changes:**
- Inject `IAuthorizationService` in constructor
- Replace `CanUserViewFeedbackAsync()` calls with `_authorizationService.RequireFeedbackViewPermissionAsync()`
- Replace `CanUserGiveFeedbackAsync()` calls with `_authorizationService.CanGiveFeedbackAsync()`
- Remove `CanUserViewFeedbackAsync()` and `CanUserGiveFeedbackAsync()` methods (moved to AuthorizationService)

### Phase 3: Update Service Registration

**Files to Modify:**
- `HrAPI/Program.cs`

**Changes:**
- Add service registration: `builder.Services.AddScoped<IAuthorizationService, AuthorizationService>();`

## Authorization Logic Consolidation

The centralized AuthorizationService will implement these business rules:

1. **Manager Permissions**: Managers can view/edit all employee profiles, view all absence requests, and approve/decline absence requests
2. **Employee Profile Access**: Users can view their own full profile; others see limited view unless they are managers
3. **Employee Profile Editing**: Users can edit their own profile; managers can edit any profile
4. **Feedback Viewing**: Users can view feedback they received; managers can view any feedback
5. **Feedback Giving**: Users can give feedback to any other employee (except themselves)
6. **Absence Request Management**: Only managers can approve/decline absence requests and view pending approvals

## Benefits of This Refactor

1. **Centralized Logic**: All authorization rules in one place for easier maintenance
2. **Reusability**: Authorization methods can be reused across services
3. **Testability**: Authorization logic can be unit tested independently
4. **Consistency**: Standardized authorization patterns across all services
5. **Maintainability**: Changes to authorization rules only require updates in one service
6. **Clean Separation**: Business logic separated from authorization concerns

## Implementation Notes

- Keep existing service interfaces unchanged to maintain API compatibility
- Use dependency injection for the new AuthorizationService
- Maintain existing exception types (`UnauthorizedAccessException`) for consistent error handling
- All authorization methods will be async to maintain consistency with existing patterns
- The AuthorizationService will have access to HrDbContext for role checking and employee lookups
